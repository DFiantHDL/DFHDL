package RISCV
import DFiant._

trait Proc extends DFDesign {
  ////////////////////////////////////////////////////////////////////////
  // Fetch
  ////////////////////////////////////////////////////////////////////////
  private val pcGen = new PCGen {}
  private val imem = new IMem {}
  imem.addr <> pcGen.pcCurrent
  ////////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////////
  // Decode
  ////////////////////////////////////////////////////////////////////////
  private val decoder = new Decoder {}
  decoder.inst <> imem.inst
  ////////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////////
  // Register File (Read)
  ////////////////////////////////////////////////////////////////////////
  private val regFile = new RegFile {}
  regFile.rs1_addr <> decoder.rs1_addr
  regFile.rs2_addr <> decoder.rs2_addr
  pcGen.rs1_data <> regFile.rs1_data
  pcGen.rs2_data <> regFile.rs2_data
  pcGen.branchSel <> decoder.branchSel
  pcGen.imm <> decoder.imm
  ////////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////////
  // ALU (Execute)
  ////////////////////////////////////////////////////////////////////////
  private val aluOp1 = DFBits(32).matchdf(decoder.rs1OpSel)
    .casedf(RS1OpSel.RegSource) {regFile.rs1_data}
    .casedf_                    {decoder.imm}
  private val aluOp2 = DFBits(32).matchdf(decoder.rs2OpSel)
    .casedf(RS2OpSel.RegSource) {regFile.rs2_data}
    .casedf(RS2OpSel.PC)        {pcGen.pcCurrent}
    .casedf_                    {decoder.imm}
  private val alu = new ALU {}
  alu.op1 <> aluOp1
  alu.op2 <> aluOp2
  alu.shamt <> decoder.shamt
  alu.aluSel <> decoder.aluSel
  ////////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////////
  // Memory
  ////////////////////////////////////////////////////////////////////////
  private val dmem = new DMem {}
  dmem.addr <> alu.out
  dmem.dataToMem <> regFile.rs2_data
  ////////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////////
  // Write Back
  ////////////////////////////////////////////////////////////////////////
  private val wbData = DFBits(32).matchdf(decoder.wbSel)
    .casedf(WriteBackSel.ALU)     {alu.out}
    .casedf(WriteBackSel.PCPlus4) {pcGen.pcPlus4}
    .casedf_                      {dmem.dataFromMem}
  regFile.rd_data <> wbData
  regFile.rd_wren <> decoder.rd_wren
  regFile.rd_addr <> decoder.rd_addr
  ////////////////////////////////////////////////////////////////////////


}
